{% macro chart(id, data) %}
{% set data_table = [data, 'data'] | table %}

<div class="govuk-tabs" data-module="govuk-tabs" style="width: 100%; height: 100%; margin: 30px 0; background-color: #fff;">
    <ul class="govuk-tabs__list" role="tablist">
        <li class="govuk-tabs__list-item govuk-tabs__list-item--selected" role="presentation">
            <a class="govuk-tabs__tab" href="#chart{{ id }}_tab" id="tab_chart_{{ id }}tab" role="tab" aria-controls="chart{{ id }}_tab" aria-selected="true" tabindex="0">
                Chart
            </a>
        </li>
        <li class="govuk-tabs__list-item" role="presentation">
            <a class="govuk-tabs__tab" href="#data_table{{ id }}_tab" id="tab_data_table{{ id }}_tab" role="tab" aria-controls="data_table{{ id }}_tab" aria-selected="false" tabindex="-1">
                Data
            </a>
        </li>
        <li class="govuk-tabs__list-item" role="presentation">
            <a class="govuk-tabs__tab" href="#download{{ id }}_tab" id="tab_download{{ id }}tab" role="tab" aria-controls="download{{ id }}_tab" aria-selected="false" tabindex="-1">
                Download
            </a>
        </li>
    </ul>
    <p class="govuk-body-s" style="display: none;">
        <a href="javascript:;" class="govuk-link" onclick="toggle{{ id }}()">View data</a> | Download <a href="javascript:;" class="govuk-link" onclick="chart{{ id }}.download()">Chart</a> <a href="javascript:;" class="govuk-link">Data</a>
    </p>

    <div class="govuk-tabs__panel" id="chart{{ id }}_tab" role="tabpanel" aria-labelledby="tab_chart{{ id }}_tab">
        <h2 class="govuk-visually-hidden">
            Chart
        </h2>

        <div id="chart{{ id }}" style="display: block; width: 100%; height: 100%;"></div>
    </div>

    <div class="govuk-tabs__panel" id="data_table{{ id }}_tab" role="tabpanel" aria-labelledby="tab_data_table{{ id }}_tab">
        <h2 class="govuk-visually-hidden">
            Data
        </h2>

        <div style="max-height: 400px; overflow-y: scroll;">
            <table id="table{{ id }}" class="govuk-body-s table-container" style="width: 100%;">
                {% for row in data_table %}
                <tr>
                    {% for cell in row %}
                    <td>{{ cell }}</td>
                    {% endfor %}
                </tr>
                {% endfor %}
            </table>
        </div>
    </div>

    <div class="govuk-tabs__panel" id="download{{ id }}_tab" role="tabpanel" aria-labelledby="tab_download{{ id }}_tab">
        <h2 class="govuk-visually-hidden">
            Download
        </h2>

        <p class="govuk-body">
            <a href="#" class="govuk-link">
                Download the data
            </a>
        </p>
    </div>

    <div id="chart{{ id }}_data" style="display: none; width: 100%; height: 100%;">
        <table id="table{{ id }}" class="govuk-body-s table-container" style="width: 100%;">
            {% for row in data_table %}
            <tr>
                {% for cell in row %}
                <td>{{ cell }}</td>
                {% endfor %}
            </tr>
            {% endfor %}
        </table>
    </div>
    <script>
        let chart{{ id }}
        window.document.addEventListener('DOMContentLoaded', function () {
            chart{{ id }} = new Chart(
                'chart{{ id }}',
                `${location.protocol}//${location.host}{{ [data, 'data'] | attribute | safe }}`,
                {{ data | safe }}
            )

            //document.getElementById('chart{{ id }}_download').addEventListener('click', function () {
            //    chart{{ id }}.download()
            //})

            try {
                if (!tbl{{ id }}) new DataTable('table{{ id }}', null, { 'dataFormat': 'array', 'allowColumnResize': true, 'allowFilter': true, 'allowSort': true, 'allowPagination': false, 'showColumns': false })
            }
            catch (e) {}
        })

        let tbl{{ id }} = false
        function toggle{{ id }}() {
            if (document.getElementById('chart{{ id }}').style.display == 'block') {
                try {
                    if (!tbl{{ id }}) new DataTable('table{{ id }}', null, { 'dataFormat': 'array', 'allowColumnResize': true, 'allowFilter': true, 'allowSort': true, 'allowPagination': false, 'showColumns': false })
                }
                catch (e) {}
                document.getElementById('chart{{ id }}').style.display = 'none'
                document.getElementById('chart{{ id }}_data').style.display = 'block'
                tbl{{ id }} = true
            } else {
                document.getElementById('chart{{ id }}').style.display = 'block'
                document.getElementById('chart{{ id }}_data').style.display = 'none'
            }
        }
    </script>
</div>
{% endmacro %}
