{% extends 'base.html' %}
{% from 'components/visualisation.html' import visualisation %}
{% from 'components/placeholder.html' import placeholder %}
{% set ns = namespace(counter1=0, counter2=0) %}
{% block title %}Demo{% endblock %}

{% block backLink %}
<a href="/" class="govuk-back-link">Back</a>
{% endblock %}

{% block content %}
<div class="govuk-grid-row govuk-grid-row-full-width">
    <h1 class="govuk-heading-l">{{ title }}</h1>
    <p class="govuk-body">{{ [content, 'Summary'] | content }}</p>

    <ol class="govuk-list govuk-list--number">
        {% for item in content %}
        {% if item[0] == 'Section' %}
        <li>
            <a href="#{{ item[1] | safe }}" class="govuk-link" style="display: block;">{{ item[1] | safe }}</a>
        </li>
        {% endif %}
        {% if item[0] == 'About' %}
        <li>
            <a href="#About" class="govuk-link" style="display: block;">About</a>
        </li>
        {% endif %}
        {% endfor %}
    </ol>

    {% if tabs %}
    <div class="govuk-tabs" data-module="govuk-tabs">
        <ul class="govuk-tabs__list">
            {% set ns.counter1 = 0 %}
            {% for item in content %}
            {% if item[0] == 'Tab' %}
            <li class="govuk-tabs__list-item govuk-tabs__list-item{% if ns.counter1 == 0 %}--selected{% endif %}">
                <a class="govuk-tabs__tab" href="#tab-{{ ns.counter1 }}" onclick="javascript:;">
                    {{ [item, 'Title'] | content }}
                </a>
            </li>
            {% set ns.counter1 = ns.counter1 + 1 %}
            {% endif %}
            {% endfor %}
        </ul>

        {% set ns.counter1 = 0 %}
        {% set ns.counter2 = 0 %}
        {% for item in content %}
        {% if item[0] == 'Tab' %}
        <div class="govuk-tabs__panel{% if ns.counter1 == 0 %} govuk-tabs__panel--hidden{% endif %}" id="tab-{{ ns.counter1 }}">
            <h2 class="govuk-heading-l">{{ [item, 'Title'] | content }}</h2>

            {% for subitem in item[1] %}
            {% if subitem[0] == 'Subtitle' %}
            <h4 class="govuk-heading-s">{{ subitem[1] | safe }}</h4>
            {% endif %}

            {% if subitem[0] == 'Chart' %}
            <div style="height: 500px;">
                {{ visualisation(ns.counter2, 'chart', subitem[1]) }}
            </div>
            {% endif %}

            {% if subitem[0] == 'Map' %}
            <div style="height: 900px;">
                {{ visualisation(ns.counter2, 'map', subitem[1]) }}
            </div>
            {% endif %}

            {% if subitem[0] == 'Text' %}
            <p class="govuk-body">{{ subitem[1] | safe }}</p>
            {% endif %}
            {% set ns.counter2 = ns.counter2 + 1 %}
            {% endfor %}
        </div>
        {% set ns.counter1 = ns.counter1 + 1 %}
        {% endif %}
        {% endfor %}
    </div>
    {% endif %}

    {% for item in content %}
    {% if item[0] not in ['Title', 'Summary', 'Tab'] %}

    {% if item[0] == 'Section' %}
    <hr style="margin: 40px 0;">
    <h3 class="govuk-heading-m"><a name="{{ item[1] | safe }}"></a>{{ item[1] | safe }}</h3>
    {% endif %}

    {% if item[0] == 'Subtitle' %}
    <h3 class="govuk-heading-m">{{ item[1] | safe }}</h3>
    {% endif %}

    {% if item[0] == 'Text' %}
    <p class="govuk-body">{{ item[1] | safe }}</p>
    {% endif %}

    {% if item[0] == 'Chart' %}
    <div style="height: 500px;">
        {{ visualisation(ns.counter1, 'chart', item[1]) }}
    </div>
    {% endif %}

    {% if item[0] == 'Map' %}
    <div style="height: 900px;">
        {{ visualisation(ns.counter1, 'map', item[1]) }}
    </div>
    {% endif %}

    {% if item[0] == 'Grid' %}
    <div class="grid" style="max-width: 775px;">
        {% for subitem in item[1] %}
        {% if subitem[0] == 'Chart' %}
        <div style="height: 500px;">
            {{ visualisation(ns.counter2, 'chart', subitem[1]) }}
        </div>
        {% endif %}
        {% set ns.counter2 = ns.counter2 + 1 %}
        {% endfor %}
    </div>
    {% endif %}

    {% if item[0] == 'Placeholder' %}
    <div style="height: 500px;">
        {{ placeholder(ns.counter1, item[1]) }}
    </div>
    {% endif %}

    {% if item[0] == 'About' %}
    <hr style="margin: 40px 0;">
    <h3 class="govuk-heading-m"><a name="About"></a>About</h3>
    {% set ns.counter2 = 0 %}
    {% for subitem in item[1] %}
    <p class="govuk-body"{% if ns.counter2 % 2 == 0 %} style="margin-bottom: 5px; font-weight: bold;"{% endif %}>{{ subitem[1] | safe }}</p>
    {% set ns.counter2 = ns.counter2 + 1 %}
    {% endfor %}
    {% endif %}

    {% set ns.counter1 = ns.counter1 + 1 %}
    {% endif %}
    {% endfor %}
</div>
<script>
    let map, chart
    function mapselect(a) {
        try {
            const el = a.map.el.substr(3)
            map = eval(`map${el}`)
            chart = eval(`chart${el}`)

            if (typeof a !== 'undefined') {
                document.getElementById(`map_marker${el}`).style.visibility = 'visible'
                document.getElementById(`map_legend${el}`).innerText = `${a.name}: ${a.value}`
                document.getElementById(`map_marker${el}`).style.marginLeft = `calc(${parseInt(a.rank.split('/')[0], 10) / parseInt(a.rank.split('/')[1], 10) * 100}% - 15px)`
                map.highlight(a.name)
                chart.highlight(a.name)
            } else {
                map.resetHighlight()
                chart.resetHighlight()
            }
        }
        catch (e) {}
    }

    (function() {
        //
    })()
</script>
{% endblock %}
