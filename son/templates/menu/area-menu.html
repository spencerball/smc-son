{% macro areamenu(menu, selectedarea, selected) %}
    <h3 class="govuk-heading-s">Find an area</h3>
    <div id="search">
        <input id="searchquery" type="text" placeholder="Find an area" oninput="search(this.value)" onmouseenter="showresults()" _onmouseleave="document.getElementById('searchresults').style.display = 'none'">
        <div id="searchresults" onmouseenter="showresults()" _onmouseleave="this.style.display = 'none'"></div>
    </div>

    <nav aria-label="Side navigation" class="moj-side-navigation govuk-!-padding-right-4 govuk-!-padding-top-0" role="navigation">
        <ul id="sidemenu" class="moj-side-navigation__list none-collapsible">
            {% for area in menu.areas | sort(attribute='name') %}

            <li class="moj-side-navigation__item{% if (area.name | url_link) == (selectedarea | url_link) %} is-active{% endif %}"{% if not loop.index in selected %} style="display: none;"{% endif %}>
                <a href="/social_mobility_by_area/{{ area.name | url_link }}" class="moj-primary-navigation__link"{% if (area.name | url_link) == (selectedarea | url_link) %} aria-current="page"{% endif %}>{{ area.name }}
                <div id="{{ area.name }}_matches" style="color: #777; font-size: smaller;"></div></a>
            </li>

            {% endfor %}
            <li id="sidemenu_showmore" class="_moj-side-navigation__item">
                <a href="javascript:;" class="govuk-link" style="padding-left: 14px;" onclick="expandnavigation()">Show more</a>
            </li>
            <li id="sidemenu_showless" class="_moj-side-navigation__item" style="display: none;">
                <a href="javascript:;" class="govuk-link" style="padding-left: 14px;" onclick="collapsenavigation()">Show less</a>
            </li>
        </ul>

        <hr class="govuk-section-break govuk-section-break--m govuk-!-margin-top-3 govuk-!-margin-bottom-3 govuk-section-break--visible">
        <!--<h4 class="moj-side-navigation__title">Pages</h4>-->
        <ul class="govuk-!-font-size-14 govuk-!-margin-left-0 govuk-!-font-size-14 govuk-!-margin-left-0 moj-side-navigation__list">
            <li class="moj-side-navigation__item"><a href="#">Background</a></li>
            <li class="moj-side-navigation__item"><a href="#">About our analysis</a></li>
        </ul>
    </nav>
    <script>
        const areas = {{ menu.areas | safe }}

        function search(value) {
            let found = []
            for (area of areas) {
                document.getElementById(`${area.name}_matches`).innerHTML = ''
            }

            if (value.length > 2) {
                found = found.concat(areas.filter(x => x.name.toLowerCase().indexOf(value.toLowerCase()) > -1))
                found = found.concat(areas.filter(x => (x.itl3.map(x => x.toLowerCase()).map(x => x.indexOf(value.toLowerCase()) > -1)).indexOf(true) > -1))
                found = found.concat(areas.filter(x => (x.la.map(x => x.toLowerCase()).map(x => x.indexOf(value.toLowerCase()) > -1)).indexOf(true) > -1))

                if (found.length > 0) {
                    found = found.filter(function (value, index, array) { return array.indexOf(value) === index }).map(x => x.name)
                    const menu = document.getElementById('sidemenu').children

                    for (let i = 0; i < menu.length; i++) {
                        const item = menu[i].innerText.trim()
                        if (found.indexOf(item) > -1) {
                            menu[i].style.display = 'unset'
                            const area = areas.filter(x => x.name.toLowerCase() == item.toLowerCase())[0]
                            let matches = []
                            matches = matches.concat(area.itl3.filter(x => x.toLowerCase().indexOf(value.toLowerCase()) > -1))
                            matches = matches.concat(area.la.filter(x => x.toLowerCase().indexOf(value.toLowerCase()) > -1))
                            matches = matches.filter(function (value, index, array) { return array.indexOf(value) === index }).map(x => x).sort()
                            matches = matches.map(x => `${x.substring(0, x.toLowerCase().indexOf(value.toLowerCase()))}<strong>${x.substring(x.toLowerCase().indexOf(value.toLowerCase()), x.toLowerCase().indexOf(value.toLowerCase()) + value.length)}</strong>${x.substring(x.toLowerCase().indexOf(value.toLowerCase()) + value.length)}`)
                            document.getElementById(`${area.name}_matches`).innerHTML = matches.join(', ')
                        } else {
                            menu[i].style.display = 'none'
                        }
                    }
                    document.getElementById('sidemenu_showmore').style.display = 'none'
                    document.getElementById('sidemenu_showless').style.display = 'none'
                }
            } else {
                collapsenavigation()
            }
        }

        function select(value) {
            document.getElementById('searchquery').value = value
            document.getElementById('searchresults').style.display = 'none'
            document.getElementById('searchresults').innerHTML = ''
        }

        function showresults() {
            const results = document.getElementById('searchresults')
            if (results.innerHTML != '' && results.style.display == 'none') {
                results.style.display = 'block'
            }
        }

        function expandnavigation() {
            const menu = document.getElementById('sidemenu').children
            for (let i = 0; i < menu.length; i++) {
                menu[i].style.display = 'unset'
            }
            document.getElementById('sidemenu_showmore').style.display = 'none'
            document.getElementById('sidemenu_showless').style.display = 'unset'
        }

        function collapsenavigation() {
            const selected = {{ selected }}
            const menu = document.getElementById('sidemenu').children
            for (let i = 0; i < menu.length; i++) {
                menu[i].style.display = selected.indexOf(i + 1) > -1 ? 'unset' : 'none'
            }
            document.getElementById('sidemenu_showmore').style.display = 'unset'
            document.getElementById('sidemenu_showless').style.display = 'none'
        }

        (function() {
            document.getElementById('searchquery').addEventListener('keypress', function (event) {
                if (event.key === 'Enter') {
                    event.preventDefault()
                }
            })
        })()
    </script>
{% endmacro %}
